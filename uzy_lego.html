<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Марафон LEGO</title>
    <link rel="icon" href="https://cdn.7tv.app/emote/01J318BP3G000103G6KJYE1WG7/4x.webp">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        /* width */
        ::-webkit-scrollbar {
            width: 10px;
        }

        /* Track */
        ::-webkit-scrollbar-track {
            background: #202020; 
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background-color: rgba(56, 56, 56);
            /* border-radius: 10px; */
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
            width: 30px;
        }
        
        audio::-webkit-media-controls-panel {
            background-color: #202020;
            color: white;
            max-width: 50px;
        }


        video{
            opacity: 12%;
            margin: 0;
            padding: 0;
            position: absolute;
            width: 100%;
            height: 100vh;
            object-fit: cover;
            top: 0;
            mask-image: linear-gradient(180deg, rgba(0,0,0,1) 10%, rgba(0,0,0,.8) 30%, rgba(0,0,0,.6) 40%, rgba(0,0,0,0) 100%);
            z-index: -10;
        }
        body{
            background-color: #202020;
            color: white;
            font-family: "Fira Sans", serif;
            margin: 0;
            scroll-behavior: smooth;

            height: 100vh;
            /* overflow: hidden; */
            /* overscroll-behavior-y: none; */
            display: flex;
            flex-direction: column;
        }
        .header{
            height: 150px;
            width: auto;
            align-items: center;
            text-align: center;
            margin-bottom: 30px;
        }
        .header > *{
            display: inline-block;
        }
        .header img{
            /* width: 100px; */
            height: 120px;
            z-index: 100;
            cursor: pointer;
        }
        h1, h2, h5{
            /* width: auto; */
            margin: 10px 0;
            text-align: center;
            font-family: "Dela Gothic One", serif;
            font-weight: lighter;
        }
        h1{
            margin-top: 20px;
        }
        h2::before{
            content: "Сейчас играем в ";
        }
        #progress::before{
            content: "Пройдено игр: ";
        }
        #now-year::before{
            content: "Год: ";
            margin-left: 30px;
        }
        h1, h2, h5, a{
            color: rgb(221, 146, 96);
        }
        #now-playing{
            text-decoration: underline;
            cursor: pointer;
        }
        
        #table-container{
            flex:1;
            overflow: hidden;
            overflow-x: none;
            overflow-y: scroll;
            margin: 0 auto;
            width: 85%;
        }
        table {
            border-collapse: collapse;
            margin-bottom: 200px;

            /* height: 100%;
            display: flex;
            flex-direction: column; */

            position: relative;
        }
        tbody:first-child{
            position: sticky;
            top: 0;
            z-index: 100;
        }
        table a{
            font-weight: bold;
        }
        table a i{
            color: rgb(221, 146, 96);
            font-size: 10px;
        }
        /* tbody{
            border-top: 1px solid #ddd;
        } */
        tbody:nth-child(odd) {
            background-color: rgb(80, 80, 80, 0.15);
        }
        th, td {
            /* border: 1px solid #ddd; */
            padding: 8px;
            text-align: left;
            font-weight: 300;
        }
        .col-0, .col-2, .col-3, .col-4, .col-5, .col-6, .col-7, th{
            border-bottom: 1px solid #444;
        }
        .col-0, .col-3, .col-4, .col-5, .col-6, .col-7{
            text-align: center;
        }
        th {
            background-color: rgba(56, 56, 56);
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            border-bottom: none;
        }
        .playing-this{
            background-color: rgb(221, 146, 96, 0.2);
        }

        .author{
            position: fixed;
            font-size: 13px;
            opacity: 50%;
            bottom: 0;
            right: 0;
            margin: 10px;
            text-align: right;
        }
        .author img{
            height: 13px;
        }
        .author a{
            color: white;
        }

        #suck-my-dick-player{
            position: fixed;
            bottom: 0;
            left: 0;
            margin: 5px;
            margin-left: 10px;
            z-index: 10;

            -webkit-transition: .5s;
            transition: opacity .5s;
            opacity: 10%;
        }
        #suck-my-dick-player:hover{
            -webkit-transition: .5s;
            transition: opacity .5s;
            background-color: #202020;
            border-radius: 30px;
            opacity: 100%;
        }
        #suck-my-dick-player img, #suck-my-dick-player span{
            -webkit-transition: .5s;
            transition: opacity .5s;
            opacity: 0%;
        }
        #suck-my-dick-player img{
            width: 20px;
            height: auto;
        }
        #suck-my-dick-player span{
            padding-right: 15px;
        }
        #suck-my-dick-player:hover img, #suck-my-dick-player:hover span{
            -webkit-transition: .5s;
            transition: opacity .5s;
            opacity: 100%;
        }
        #suck-my-dick-player button{
            background: none;
	        color: inherit;
	        border: none;
	        padding: 0;
	        font: inherit;
	        cursor: pointer;
	        outline: inherit;

            padding: 5px;
            font-size: 24px;
        }
        #play-pause, #mute{
            width: 30px;
        }
        /* #mute{
            margin-right: 10px;
        } */
        #volume-control {
            -webkit-appearance: none;  /* Override default CSS styles */
            appearance: none;
            background: rgb(255, 255, 255, 0.1); /* Grey background */
            outline: none; /* Remove outline */
            border: 1px solid white;
            border-radius: 20px;
        }
        #volume-control::-webkit-slider-thumb {
            -webkit-appearance: none; /* Override default look */
            appearance: none;
            width: 15px; /* Set a specific slider handle width */
            height: 15px; /* Slider handle height */
            background: white; /* Green background */
            cursor: pointer; /* Cursor on hover */
            border-radius: 50%;
        }

        #volume-control::-moz-range-thumb {
            width: 15px; /* Set a specific slider handle width */
            height: 15px; /* Slider handle height */
            background: white; /* Green background */
            cursor: pointer; /* Cursor on hover */
            border-radius: 50%;
        }

        @media(max-width: 1000px){
            #table-container{
                width: calc(100% - 20px);
                padding: 0 10px;
            }
            table *{
                font-size: 14px;
            }
        }

        @media(max-width: 730px){
            h1, h2, h5{
                /* width: auto; */
                margin: 10px 0;
            }
            h1{
                margin-top: 10px;
                font-size: 24px;
            }
            h2{
                font-size: 18px;
            }
            .header{
                height: 120px;
            }
            .header img{
                height: 100px;
            }

            table *{
                font-size: 12px;
            }
        }

        @media(max-width: 570px){
            h1{
                margin-top: 10px;
                font-size: 20px;
            }
            h2{
                font-size: 14px;
            }
            .header{
                height: 90px;
            }
            .header img{
                display: none;
            }

            table *{
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="video">
        <video id="ya-lega-video" src="" autoplay muted loop></video>
        <audio id="ya-lega-audio" src="" style="display: none;"></audio>
    </div>

    <div class="header">
        <img src="/lego/lego.webp" onclick="YA_LEEEEGAAAAAA()">
        <div class="title">
            <h1>МАРАФОН LEGO ИГР</h1>
            <h2><span id="now-playing"></span></h2>
            <h5><span id="progress"></span><span id="now-year"></span></h5>
        </div>
        <img src="/lego/lego.webp" onclick="YA_LEEEEGAAAAAA()">
    </div>
    <div id="table-container"></div>

    <div class="author">
        <img src="https://cdn.7tv.app/emote/647e08cd628540685215bdbc/1x.webp"/> страницу создал klabisot<br>
        <!-- <a href="https://ttvfreaks.github.io/mf_kitchen">Кухня паст Маятника Фуко</a><br> -->
        <a href="https://docs.google.com/spreadsheets/d/1xT8SDlwpBTjbFbQs8BUNdhZOojhwS38-K-6Qf0EiYwI/edit?gid=0#gid=0" target="_blank">ссылка на оригинальную таблицу</a><br>
        скрипт немного неправильно считал игры <img src="https://cdn.7tv.app/emote/01J4RNW84G0006H6JAMR0FAC09/1x.webp"/> их 113, не 115
    </div>

    <div id="suck-my-dick-player">
        <audio id="suck-my-dick" loop>
            <source src="/lego/brick.mp3">
            Your browser does not support the audio element.
        </audio>
        <button id="play-pause"><i class="fa-solid fa-play"></i></button>
        <button id="mute"><i class="fa-solid fa-volume-low"></i></i></button>
        <input type="range" id="volume-control" min="0" max="1" step="0.01" value="0.07">
        <img src="/lego/suscat.webp" alt="susCat"> <span>Brick by brick, suck my dick</span>
    </div>
    <!-- <audio id="suck-my-dick" src="/lego/brick.mp3" autoplay controls loop></audio> -->

    <script>

        var suckMyDick = document.getElementById("suck-my-dick");
        let lastVolume = 0.07
        let muted = false

        suckMyDick.volume = lastVolume;
        
        document.addEventListener('DOMContentLoaded', function() {
            const playPauseButton = document.getElementById('play-pause');
            const muteButton = document.getElementById('mute');
            const volumeControl = document.getElementById('volume-control');

            playPauseButton.addEventListener('click', function() {
                if (suckMyDick.paused) {
                    suckMyDick.play();
                    playPauseButton.innerHTML = '<i class="fa-solid fa-pause"></i>';
                } else {
                    suckMyDick.pause();
                    playPauseButton.innerHTML = '<i class="fa-solid fa-play"></i>';
                }
            });
            muteButton.addEventListener('click', function() {
                if (muted) {
                    suckMyDick.volume = lastVolume;
                    volumeControl.value = lastVolume;
                    muted = false
                    muteButton.innerHTML = '<i class="fa-solid fa-volume-low"></i>';
                } else {
                    lastVolume = suckMyDick.volume
                    suckMyDick.volume = 0;
                    volumeControl.value = 0;
                    muted = true
                    muteButton.innerHTML = '<i class="fa-solid fa-volume-xmark"></i>';
                }
            });
        
            volumeControl.addEventListener('input', function() {
                suckMyDick.volume = volumeControl.value;
                lastVolume = suckMyDick.volume
            });
        });







        const replacing = {
            '2, 3': ['фикс', 'фикс', 'https://www.legoisland.org/wiki/LEGO_Island_Rebuilder'],
            '2, 7': [/особенн.*? с этой песней/, "особенно с этой песней", 'https://www.youtube.com/watch?v=vXfDoplXLjA'],
            '5, 7': ['можете посмотреть', 'можете посмотреть', 'https://www.youtube.com/watch?v=QEtoipLIZv8']
        }

        videos = [
            "/lego/alert_orig (6).webm",
            "/lego/alert_orig (8).webm"
        ]
        const random = Math.floor(Math.random() * videos.length);
        document.getElementById('ya-lega-video').setAttribute('src', videos[random])

        let audio_index = Math.floor(Math.random() * videos.length);
        async function YA_LEEEEGAAAAAA() {
            const audio = document.getElementById('ya-lega-audio')
            audio.setAttribute('src', videos[audio_index])
            audio.play();

            audio_index += 1
            if (audio_index >= videos.length){
                audio_index = 0
            }
        }

        let currentGame = ''
        let gameRow = 1
        let currentYear = 0
        async function loadSheet(url) {
            const sheetUrl = url
            const regex = /\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
            const match = sheetUrl.match(regex);

            if (!match) {
                alert('Invalid Google Sheets URL');
                return;
            }

            const sheetId = match[1];
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;

            try {
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch the data. Ensure the sheet is published and shared as "Anyone with the link can view".');
                }
                const csvText = await response.text();
                const tableHtml = csvToTable(csvText);
                document.getElementById('table-container').innerHTML = tableHtml;


                $(document).ready(function () {
                    target_offset = $(`#row-${gameRow}`).offset(),
                    target_top = target_offset.top;
                    $('#table-container').animate({
                        scrollTop: target_top - $('#table-container').height()/2
                    }, 800);
                });
                $(`#row-${gameRow}`).addClass('playing-this')
                $('#now-playing').text(currentGame.replaceAll(`"`, ""))
                $('#now-year').text(currentYear.replaceAll(`"`, ""))
                $(`tr[data-year="${currentYear.replaceAll(`"`, "")}"] .col-0`).addClass('playing-this')
            } catch (error) {
                alert(error.message);
            }
        }

        loadSheet("https://docs.google.com/spreadsheets/d/1xT8SDlwpBTjbFbQs8BUNdhZOojhwS38-K-6Qf0EiYwI/edit?gid=0#gid=0")

        function csvToTable(csv) {
            const regex = /,(?=(?:[^"]*"[^"]*")*(?![^"]*"))/;

            const rows = csv.split('\n');
            let tableHtml = '<table>';

            let years = {}
            let lastYear = "1995"
            let lastYearCount = 1
            rows.forEach((row, index) => {
                const columns = row.split(regex);

                if (columns[6] == `""` && currentGame == ""){
                    currentGame = columns[0]
                    gameRow = index
                    currentYear = lastYear
                }
                if (columns[2] == `""`){
                    lastYearCount += 1
                }
                else if (lastYear != columns[2]){
                    years[lastYear] = lastYearCount
                    lastYear = columns[2]
                    lastYearCount = 1
                }
            })
            years[lastYear] = lastYearCount
            let nowPlayingId = 0

            let needToClose = false
            rows.forEach((row, index) => {
                let columns = row.split(regex);
                let buff = columns[0]
                columns[0] = columns[2]
                columns[2] = buff

                if (index == rows.length - 1){
                    return
                }

                if (index > 0 && columns[0] != `""`){
                    if (needToClose) {
                        tableHtml += `</tbody>`
                    }
                    tableHtml += `<tbody>`
                    needToClose = true
                }
                tableHtml += `<tr id="row-${index}" data-year="${columns[0].replaceAll("\"", "")}">`;

                if (columns[6] == `""` && nowPlayingId == 0){
                    nowPlayingId = index
                } 

                columns.forEach((column, col_index) => {
                    if (col_index != 1 && col_index < 8){
                        let rowspan = 1
                        if (col_index == 0){
                            rowspan = years[column]
                        }
                        if (rowspan){
                            col_text = column.replaceAll("\"", "")
                            replacing_index = `${index}, ${col_index}`
                            if (replacing_index in replacing){
                                console.log(replacing_index)
                                a_pattern = replacing[replacing_index][0]
                                a_text = replacing[replacing_index][1]
                                a_href = replacing[replacing_index][2]
                                col_text = col_text.replace(
                                    a_pattern, 
                                    `<a href="${a_href}">${a_text} <i class="fa-solid fa-up-right-from-square"></i></a>`)
                            }
                            tableHtml += index === 0 && column != `""` ? `<th>${col_text}</th>` : `<td class="col-${col_index}" rowspan="${rowspan}">${col_text}</td>`;
                        }
                    }
                });

                tableHtml += '</tr>';
            });

            document.getElementById('progress').innerText = `${nowPlayingId-1}/113`

            tableHtml += `</tbody>`
            tableHtml += '</table>';
            return tableHtml;
        }

        $(document).on('wheel', function(event) {
            var $scrollableDiv = $('#table-container');

            // Отменяем стандартное поведение прокрутки
            event.preventDefault();

            // Прокручиваем div в зависимости от направления прокрутки
            $scrollableDiv.scrollTop($scrollableDiv.scrollTop() + event.originalEvent.deltaY);
        });
        $('.header span').on('click', function(event) {
            target_offset = $(`#row-${gameRow}`).offset(),
            target_top = target_offset.top;
            $('#table-container').animate({
                scrollTop: target_top - $('#table-container').height()/2
            }, 800);
        });
    </script>
</body>
</html>
